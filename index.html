<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Ultimate Private Chat</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; height: 100vh; background: #f0f2f5; }
        #sidebar { width: 280px; background: #fff; border-right: 1px solid #ddd; display: flex; flex-direction: column; }
        .sidebar-header { padding: 15px; font-weight: bold; background: #f8f9fa; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;}
        
        #userList { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        #userList li { padding: 12px 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        #userList li:hover { background: #f0f7ff; }
        
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #ccc; }
        .status-dot.online { background: #4caf50; box-shadow: 0 0 5px #4caf50; }

        #chat-container { flex: 1; display: flex; flex-direction: column; }
        #messages { flex: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; background: #e5ddd5; }
        
        .msg { max-width: 70%; padding: 8px 12px; border-radius: 12px; font-size: 14px; position: relative; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .msg.my { align-self: flex-end; background: #dcf8c6; }
        .msg.others { align-self: flex-start; background: #fff; }
        
        .status-tick { font-size: 10px; margin-left: 5px; color: #999; float: right; margin-top: 5px; }
        .status-tick.seen { color: #34b7f1; }
        .chat-img { max-width: 100%; border-radius: 8px; margin-top: 5px; display: block; }

        /* –ü–∞–Ω–µ–ª—å —Å–º–∞–π–ª–∏–∫–æ–≤ */
        .emoji-bar { padding: 5px 15px; background: #fff; border-top: 1px solid #eee; display: flex; gap: 10px; font-size: 20px; }
        .emoji-bar span { cursor: pointer; transition: transform 0.1s; }
        .emoji-bar span:hover { transform: scale(1.3); }

        .input-area { padding: 10px 15px 15px; background: white; display: flex; gap: 10px; }
        input { flex: 1; border: 1px solid #ddd; padding: 10px 15px; border-radius: 20px; outline: none; }
        button { background: #0084ff; color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; }
    </style>
</head>
<body>

<div id="sidebar">
    <div class="sidebar-header">–í—ã: <span id="myName">...</span></div>
    <ul id="userList"></ul>
</div>

<div id="chat-container">
    <div class="sidebar-header" id="chatWith">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–∞</div>
    <div id="messages"></div>
    
    <div class="emoji-bar" id="emojiBar" style="display:none;">
        <span onclick="addEmoji('üòÄ')">üòÄ</span>
        <span onclick="addEmoji('üòÇ')">üòÇ</span>
        <span onclick="addEmoji('‚ù§Ô∏è')">‚ù§Ô∏è</span>
        <span onclick="addEmoji('üëç')">üëç</span>
        <span onclick="addEmoji('üî•')">üî•</span>
        <span onclick="addEmoji('üòé')">üòé</span>
        <span onclick="addEmoji('ü§î')">ü§î</span>
        <span onclick="addEmoji('üôå')">üôå</span>
    </div>

    <div class="input-area">
        <input type="text" id="msgInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ..." disabled onkeypress="if(event.key === 'Enter') sendMessage()">
        <button onclick="sendMessage()" id="sendBtn" disabled>‚û§</button>
    </div>
</div>

<audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3"></audio>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onChildChanged, set, onValue, onDisconnect, serverTimestamp, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAbulx85P1UVmdN7WeP1v4yZOxAxLT4-5E",
        authDomain: "chat-25292.firebaseapp.com",
        databaseURL: "https://chat-25292-default-rtdb.firebaseio.com",
        projectId: "chat-25292",
        storageBucket: "chat-25292.appspot.com",
        messagingSenderId: "982262580373",
        appId: "1:982262580373:web:d411a8b651de02afcd879c"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let myName = localStorage.getItem('chat_username') || prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è:") || "User" + Math.floor(Math.random()*100);
    localStorage.setItem('chat_username', myName);
    document.getElementById('myName').textContent = myName;

    // –°—Ç–∞—Ç—É—Å ONLINE
    const myStatusRef = ref(db, 'status/' + myName);
    set(myStatusRef, { online: true, lastSeen: serverTimestamp() });
    onDisconnect(myStatusRef).set({ online: false, lastSeen: serverTimestamp() });

    let currentChatId = null;
    let recipient = null;

    onValue(ref(db, 'status'), (snapshot) => {
        const userList = document.getElementById('userList');
        userList.innerHTML = "";
        snapshot.forEach(child => {
            const name = child.key;
            if (name !== myName) {
                const data = child.val();
                const li = document.createElement('li');
                li.innerHTML = `${name} <span class="status-dot ${data.online ? 'online' : ''}"></span>`;
                li.onclick = () => startChat(name);
                userList.appendChild(li);
            }
        });
    });

    window.addEmoji = (emoji) => {
        document.getElementById('msgInput').value += emoji;
        document.getElementById('msgInput').focus();
    };

    function startChat(target) {
        recipient = target;
        currentChatId = [myName, target].sort().join("_");
        document.getElementById('chatWith').textContent = "–ß–∞—Ç —Å " + target;
        document.getElementById('msgInput').disabled = false;
        document.getElementById('sendBtn').disabled = false;
        document.getElementById('emojiBar').style.display = 'flex';
        
        const msgDiv = document.getElementById('messages');
        msgDiv.innerHTML = "";

        const chatRef = ref(db, 'private_messages/' + currentChatId);
        onChildAdded(chatRef, (data) => {
            const val = data.val();
            renderMessage(data.key, val);
            if (val.sender !== myName) {
                update(ref(db, `private_messages/${currentChatId}/${data.key}`), { seen: true });
                document.getElementById('notifSound').play().catch(()=>{}); // –ü—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –∑–≤—É–∫
            }
        });

        onChildChanged(chatRef, (data) => {
            const el = document.getElementById('msg-' + data.key);
            if (el && data.val().seen) {
                const tick = el.querySelector('.status-tick');
                if (tick) tick.classList.add('seen');
            }
        });
    }

    window.sendMessage = () => {
        const input = document.getElementById('msgInput');
        if (!input.value.trim()) return;

        push(ref(db, 'private_messages/' + currentChatId), {
            sender: myName,
            text: input.value,
            seen: false,
            timestamp: serverTimestamp()
        });
        input.value = "";
    };

    function renderMessage(id, data) {
        if(document.getElementById('msg-' + id)) return;
        const msgDiv = document.getElementById('messages');
        const div = document.createElement('div');
        div.id = 'msg-' + id;
        div.className = `msg ${data.sender === myName ? 'my' : 'others'}`;
        
        const isImage = data.text.match(/\.(jpeg|jpg|gif|png|webp)$/i) != null || (data.text.startsWith('http') && data.text.length > 15);
        let content = data.text;
        
        if (isImage) {
            content = `<img src="${data.text}" class="chat-img" onerror="this.outerHTML='${data.text}'">`;
        }

        const ticks = data.sender === myName ? `<span class="status-tick ${data.seen ? 'seen' : ''}">‚úî‚úî</span>` : '';
        div.innerHTML = `<div>${content}</div>${ticks}`;
        msgDiv.appendChild(div);
        msgDiv.scrollTop = msgDiv.scrollHeight;
    }
</script>
</body>
</html>
