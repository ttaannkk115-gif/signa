<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universe Elite Pro</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    
    <style>
        :root {
            --main: #0088cc; --bg-main: #d1d7db; --bg-container: #ffffff;
            --bg-chat: #e5ddd5; --text: #000000; --msg-mine: #dcf8c6;
            --msg-others: #ffffff; --header: #ededed; --green: #4caf50; --gray: #8e8e93;
        }
        body.dark-mode {
            --bg-main: #0b141a; --bg-container: #111b21; --bg-chat: #0b141a;
            --text: #e9edef; --msg-mine: #005c4b; --msg-others: #202c33; --header: #202c33;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, sans-serif; }
        body { background: var(--bg-main); color: var(--text); display: flex; justify-content: center; height: 100vh; transition: 0.3s; }
        .container { width: 100%; max-width: 500px; background: var(--bg-container); height: 100vh; display: flex; flex-direction: column; position: relative; overflow: hidden; }

        header { background: var(--header); padding: 12px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(0,0,0,0.1); }
        .search-bar { padding: 10px; background: var(--bg-container); border-bottom: 1px solid rgba(0,0,0,0.05); }
        .search-bar input { width: 100%; padding: 8px 15px; border-radius: 20px; border: none; background: var(--header); color: var(--text); outline: none; }

        .user-item { padding: 12px 15px; border-bottom: 1px solid rgba(0,0,0,0.05); cursor: pointer; display: flex; align-items: center; gap: 12px; }
        .avatar { width: 48px; height: 48px; border-radius: 50%; object-fit: cover; background: var(--main); color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; position: relative; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; border: 2px solid var(--bg-container); position: absolute; bottom: 2px; right: 2px; }
        .online { background: var(--green); } .offline { background: var(--gray); }

        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: var(--bg-chat); }
        .msg-row { display: flex; gap: 8px; margin-bottom: 4px; }
        .msg-row.mine { flex-direction: row-reverse; }
        .msg { max-width: 75%; padding: 8px 12px; border-radius: 12px; position: relative; background: var(--msg-others); box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .msg.mine { background: var(--msg-mine); }
        .msg-avatar { width: 28px; height: 28px; border-radius: 50%; object-fit: cover; }

        .reactions-panel { display: none; position: absolute; bottom: 100%; left: 0; background: var(--bg-container); border-radius: 20px; padding: 5px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); gap: 8px; z-index: 10; }
        .msg:hover .reactions-panel { display: flex; }
        .reaction-badge { background: rgba(0,0,0,0.1); padding: 2px 5px; border-radius: 8px; font-size: 0.7rem; margin-top: 4px; display: inline-block; }

        #call-screen { position: absolute; top:0; left:0; width:100%; height:100%; background:#000; z-index:1000; display:none; }
        #remote-video { width:100%; height:100%; object-fit:cover; }
        #local-video { width:100px; height:140px; position:absolute; top:20px; right:20px; border:2px solid #fff; border-radius:8px; }

        .input-bar { padding: 10px; background: var(--header); display: flex; gap: 8px; align-items: center; }
        .btn { padding: 10px 15px; background: var(--main); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        
        #login-screen { padding: 40px; display: flex; flex-direction: column; gap: 15px; height: 100%; justify-content: center; text-align: center; }
        #login-screen input { padding: 12px; border-radius: 10px; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="container">
    <div id="login-screen">
        <h1>Universe Pro</h1>
        <p>–í—Ö–æ–¥ –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ —ç—Ç–æ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É</p>
        <input type="text" id="username" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn" onclick="auth()">–í–æ–π—Ç–∏ / –°–æ–∑–¥–∞—Ç—å</button>
    </div>

    <div id="chat-screen" style="display:none; height:100%; flex-direction:column;">
        <header>
            <button id="back-btn" onclick="closeChat()" style="display:none; background:none; border:none; font-size:1.5rem; cursor:pointer">‚Üê</button>
            <b id="header-title">–ß–∞—Ç—ã</b>
            <div>
                <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:1.2rem;">üåì</button>
                <button id="call-btn" onclick="startCall()" style="display:none; background:none; border:none; margin-left:10px;">üìπ</button>
                <button onclick="openProfile()" style="background:none; border:none; margin-left:10px;">‚öôÔ∏è</button>
            </div>
        </header>

        <div id="main-view" style="flex:1; overflow-y:auto;">
            <div class="search-bar"><input type="text" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="filterUsers(this.value)"></div>
            <div id="user-list-area"></div>
        </div>

        <div id="messages" style="display:none"></div>

        <div class="input-bar" id="input-bar" style="display:none">
            <button onclick="document.getElementById('file-input').click()" style="background:none; border:none;">üìé</button>
            <input type="file" id="file-input" hidden onchange="uploadFile(this)">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') send()">
            <button class="btn" onclick="send()">‚û§</button>
        </div>
    </div>

    <div id="profile-screen" style="display:none; padding:20px; text-align:center;">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</h2>
        <label><img id="p-avatar" src="" class="avatar" style="width:100px; height:100px; margin:20px auto; cursor:pointer"><input type="file" hidden onchange="uploadAvatar(this)"></label>
        <input type="text" id="p-bio" placeholder="–û —Å–µ–±–µ..." style="width:100%; padding:10px; margin-bottom:10px">
        <button class="btn" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <div id="admin-tools" style="display:none; border-top:1px solid #ccc; margin-top:20px; padding-top:20px;">
            <button class="btn" style="background:var(--green)" onclick="adminBroadcast()">üì¢ –†–∞—Å—Å—ã–ª–∫–∞ –≤—Å–µ–º</button>
        </div>
        <button class="btn" style="background:#ff3b30; margin-top:20px" onclick="logout()">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞</button>
    </div>

    <div id="call-screen">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        <button onclick="endCall()" style="position:absolute; bottom:30px; left:50%; transform:translateX(-50%); background:red; color:white; border:none; padding:15px 30px; border-radius:30px;">–ó–∞–≤–µ—Ä—à–∏—Ç—å</button>
    </div>
</div>

<script>
    // --- –ö–û–ù–§–ò–ì ---
    const firebaseConfig = { apiKey: "API_KEY", databaseURL: "URL", storageBucket: "BUCKET", projectId: "ID" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database(); const storage = firebase.storage();
    const ADMIN_PASS = "6739218";
    const badWords = ["–º–∞—Ç1", "–º–∞—Ç2"]; // –°–ø–∏—Å–æ–∫ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
    
    let currentUser = localStorage.getItem('chat_user'), activeChat = null, activeTarget = null, peer, localStream, currentCall;

    // --- –ê–í–¢–û–í–•–û–î ---
    window.onload = () => { if(currentUser) loginSuccess(currentUser); };

    function auth() {
        const u = document.getElementById('username').value.trim().toLowerCase();
        const p = document.getElementById('password').value.trim();
        if(!u || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ");
        db.ref('users/'+u).once('value', s => {
            if(s.exists() && s.val().pass !== p) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
            if(!s.exists()) db.ref('users/'+u).set({pass:p, bio:"–Ø —Ç—É—Ç!", status:"offline"});
            localStorage.setItem('chat_user', u);
            loginSuccess(u);
        });
    }

    function loginSuccess(u) {
        currentUser = u;
        document.getElementById('login-screen').style.display='none';
        document.getElementById('chat-screen').style.display='flex';
        setupPresence(); loadUsers(); initPeer();
        if(localStorage.getItem('theme')==='dark') document.body.classList.add('dark-mode');
    }

    function logout() { if(confirm("–í—ã–π—Ç–∏?")) { localStorage.removeItem('chat_user'); location.reload(); } }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('theme', document.body.classList.contains('dark-mode')?'dark':'light'); }

    // --- –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò –ò –ü–û–ò–°–ö ---
    function loadUsers() {
        db.ref('users').on('value', snap => {
            const area = document.getElementById('user-list-area'); area.innerHTML = '';
            area.innerHTML += `<div class="user-item" onclick="openChat('saved_'+currentUser, 'üîñ –ò–∑–±—Ä–∞–Ω–Ω–æ–µ')"><div class="avatar">üîñ</div><b>–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</b></div>`;
            area.innerHTML += `<div class="user-item" onclick="openChat('public_chat', 'üåê –û–±—â–∏–π —á–∞—Ç')"><div class="avatar">üåê</div><b>–û–±—â–∏–π —á–∞—Ç</b></div>`;
            snap.forEach(u => {
                if(u.key === currentUser) return;
                const d = u.val();
                area.innerHTML += `<div class="user-item" data-name="${u.key}" onclick="openChat('p2p_'+[currentUser,u.key].sort().join('_'), '${u.key}')">
                    <div class="avatar"><img src="${d.avatar||''}" style="width:100%;height:100%;border-radius:50%;object-fit:cover"><div class="status-dot ${d.status==='online'?'online':'offline'}"></div></div>
                    <div><b>${u.key}</b><br><small>${d.bio||''}</small></div></div>`;
            });
        });
    }

    function filterUsers(q) {
        document.querySelectorAll('.user-item[data-name]').forEach(i => {
            i.style.display = i.getAttribute('data-name').includes(q.toLowerCase()) ? 'flex' : 'none';
        });
    }

    // --- –ß–ê–¢ –ò –§–£–ù–ö–¶–ò–ò ---
    async function openChat(id, title) {
        activeChat = id; activeTarget = title.includes(' ') ? null : title;
        document.getElementById('header-title').textContent = title;
        document.getElementById('main-view').style.display = 'none';
        document.getElementById('messages').style.display = 'flex';
        document.getElementById('input-bar').style.display = 'flex';
        document.getElementById('back-btn').style.display = 'block';
        document.getElementById('call-btn').style.display = activeTarget ? 'block' : 'none';
        
        const users = (await db.ref('users').once('value')).val();
        db.ref('messages/'+id).on('value', s => {
            const mArea = document.getElementById('messages'); mArea.innerHTML = '';
            s.forEach(msg => {
                const d = msg.val(); const isMine = d.s === currentUser;
                const row = document.createElement('div'); row.className = `msg-row ${isMine?'mine':''}`;
                let reacts = ''; if(d.reactions) Object.keys(d.reactions).forEach(e => reacts += `<span class="reaction-badge">${e}</span>`);
                
                row.innerHTML = `<img src="${users[d.s]?.avatar||''}" class="msg-avatar">
                    <div class="msg ${isMine?'mine':''}">
                        <div class="reactions-panel"><span onclick="react('${msg.key}','‚ù§Ô∏è')">‚ù§Ô∏è</span><span onclick="react('${msg.key}','üëç')">üëç</span><span onclick="react('${msg.key}','üî•')">üî•</span></div>
                        <small><b>${d.s}</b></small><div>${d.t}</div>
                        ${d.file ? (d.fileType.includes('image')?`<img src="${d.file}" style="width:100%">`:`<video src="${d.file}" controls style="width:100%"></video>`) : ''}
                        ${reacts}
                    </div>`;
                
                row.querySelector('.msg').oncontextmenu = (e) => {
                    e.preventDefault();
                    if(isMine || (activeChat==='public_chat' && prompt("–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:")===ADMIN_PASS)) db.ref(`messages/${activeChat}/${msg.key}`).remove();
                };
                if(!isMine && activeChat !== 'saved_'+currentUser) {
                    row.querySelector('.msg').onclick = () => { if(confirm("–í –∏–∑–±—Ä–∞–Ω–Ω–æ–µ?")) db.ref('messages/saved_'+currentUser).push({s:d.s, t:d.t, ts:Date.now()}); };
                }
                mArea.appendChild(row);
            });
            mArea.scrollTop = mArea.scrollHeight;
        });
    }

    function send() {
        const inp = document.getElementById('msg-input'); let t = inp.value.trim(); if(!t) return;
        badWords.forEach(w => t = t.replace(new RegExp(w, 'gi'), '***'));
        db.ref('messages/'+activeChat).push({s:currentUser, t:t, ts:Date.now()});
        inp.value = '';
    }

    function react(mid, emo) { db.ref(`messages/${activeChat}/${mid}/reactions/${emo}`).set(true); }

    function closeChat() { document.getElementById('main-view').style.display='block'; document.getElementById('messages').style.display='none'; document.getElementById('input-bar').style.display='none'; document.getElementById('back-btn').style.display='none'; }

    // --- –ü–†–û–§–ò–õ–¨ –ò –ê–î–ú–ò–ù–ö–ê ---
    function openProfile() {
        document.getElementById('chat-screen').style.display='none';
        document.getElementById('profile-screen').style.display='block';
        db.ref('users/'+currentUser).once('value', s => {
            document.getElementById('p-bio').value = s.val().bio;
            document.getElementById('p-avatar').src = s.val().avatar || '';
        });
        if(prompt("–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞ –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:") === ADMIN_PASS) document.getElementById('admin-tools').style.display='block';
    }

    async function adminBroadcast() {
        const t = prompt("–¢–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏ –≤—Å–µ–º:"); if(!t) return;
        const users = (await db.ref('users').once('value')).val();
        Object.keys(users).forEach(u => {
            const id = 'p2p_'+[currentUser, u].sort().join('_');
            db.ref('messages/'+id).push({s:"–ê–î–ú–ò–ù", t:"üì¢ "+t, ts:Date.now()});
        });
        alert("–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!");
    }

    function saveProfile() { db.ref('users/'+currentUser).update({bio:document.getElementById('p-bio').value}); document.getElementById('profile-screen').style.display='none'; document.getElementById('chat-screen').style.display='flex'; }

    async function uploadAvatar(i) {
        const file = i.files[0]; const ref = storage.ref(`avatars/${currentUser}`);
        await ref.put(file); const url = await ref.getDownloadURL();
        db.ref('users/'+currentUser).update({avatar:url}); document.getElementById('p-avatar').src=url;
    }

    async function uploadFile(i) {
        const file = i.files[0]; const ref = storage.ref(`files/${Date.now()}`);
        await ref.put(file); const url = await ref.getDownloadURL();
        db.ref('messages/'+activeChat).push({s:currentUser, file:url, fileType:file.type, ts:Date.now()});
    }

    // --- –°–ò–°–¢–ï–ú–ù–û–ï ---
    function initPeer() {
        peer = new Peer(currentUser);
        peer.on('call', async call => {
            if(confirm("–ó–≤–æ–Ω–æ–∫ –æ—Ç "+call.peer)) {
                localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                document.getElementById('call-screen').style.display='block';
                document.getElementById('local-video').srcObject=localStream;
                call.answer(localStream);
                call.on('stream', rs => document.getElementById('remote-video').srcObject=rs);
                currentCall = call;
            }
        });
    }

    async function startCall() {
        localStream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
        document.getElementById('call-screen').style.display='block';
        document.getElementById('local-video').srcObject=localStream;
        currentCall = peer.call(activeTarget, localStream);
        currentCall.on('stream', rs => document.getElementById('remote-video').srcObject=rs);
    }

    function endCall() { if(currentCall) currentCall.close(); if(localStream) localStream.getTracks().forEach(t=>t.stop()); document.getElementById('call-screen').style.display='none'; }

    function setupPresence() {
        const r = db.ref('users/'+currentUser+'/status');
        db.ref('.info/connected').on('value', s => { if(s.val()) { r.onDisconnect().set('offline'); r.set('online'); }});
    }
</script>
</body>
</html>
