<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universe Messenger Ultimate</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <style>
        :root { --main: #075e54; --accent: #25d366; --bg: #e5ddd5; --light: #dcf8c6; --blue: #34b7f1; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background: var(--bg); height: 100vh; display: flex; justify-content: center; overflow: hidden; }

        /* –≠–∫—Ä–∞–Ω—ã */
        #login-screen, #chat-screen { width: 100%; max-width: 500px; background: #fff; height: 100vh; display: flex; flex-direction: column; position: relative; }
        #login-screen { justify-content: center; align-items: center; background: #f0f2f5; z-index: 2000; }

        /* –í–∏–¥–µ–æ–∑–≤–æ–Ω–æ–∫ */
        #call-screen { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; flex-direction: column; align-items: center; justify-content: center; }
        .video-container { position: relative; width: 100%; height: 80vh; }
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; border: 2px solid #fff; border-radius: 8px; object-fit: cover; }

        /* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        header { background: var(--main); color: #fff; padding: 10px 15px; }
        .header-row { display: flex; justify-content: space-between; align-items: center; }
        .typing-status { font-size: 0.7rem; color: var(--accent); font-style: italic; min-height: 15px; }
        
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        .recent-chats-list { flex: 1; overflow-y: auto; }
        .chat-item { display: flex; align-items: center; gap: 12px; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        
        .msg-wrapper { display: flex; gap: 8px; max-width: 85%; align-items: flex-end; }
        .msg-wrapper.mine { align-self: flex-end; flex-direction: row-reverse; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; box-shadow: 0 1px 1px rgba(0,0,0,0.1); position: relative; min-width: 60px; }
        .mine .msg { background: var(--light); }
        .others .msg { background: #fff; }

        .user-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: #ccc; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; flex-shrink: 0; overflow: hidden; }
        .input-area { padding: 10px; background: #f0f0f0; display: flex; align-items: center; gap: 8px; }
        .input-area input { flex: 1; padding: 10px; border-radius: 20px; border: none; outline: none; }
        
        #search-results { position: absolute; top: 110px; left: 5%; width: 90%; background: #128c7e; z-index: 100; border-radius: 8px; display: none; max-height: 200px; overflow-y: auto; box-shadow: 0 4px 15px rgba(0,0,0,0.2); }
        .search-item { padding: 12px; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer; }
        .read-status { font-size: 0.8rem; margin-left: 5px; }
        .read-status.read { color: var(--blue); font-weight: bold; }
        .read-status.unread { color: gray; }
    </style>
</head>
<body>

    <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3" preload="auto"></audio>

    <div id="call-screen">
        <div class="video-container">
            <video id="remote-video" autoplay playsinline></video>
            <video id="local-video" autoplay playsinline muted></video>
        </div>
        <button onclick="endCall()" style="margin-top:20px; padding:15px 30px; border-radius:30px; background:red; color:white; border:none; font-weight:bold; cursor:pointer;">–ó–ê–í–ï–†–®–ò–¢–¨</button>
    </div>

    <div id="login-screen">
        <div style="text-align:center; background:#fff; padding:30px; border-radius:15px; width:90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1);">
            <h2 style="margin-bottom:15px; color:var(--main);">Universe Chat</h2>
            <div onclick="document.getElementById('avatar-input').click()" style="width:80px; height:80px; border-radius:50%; background:#eee; margin:0 auto 15px; cursor:pointer; overflow:hidden; border:2px solid var(--main);">
                <img id="avatar-preview" style="width:100%; height:100%; object-fit:cover; display:none;">
                <span id="avatar-placeholder" style="line-height:80px; font-size:2rem;">üë§</span>
            </div>
            <input type="file" id="avatar-input" hidden onchange="previewAvatar(this)">
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; margin-bottom:15px;">
            <button onclick="login()" style="width:100%; padding:12px; background:var(--main); color:#fff; border:none; border-radius:8px; font-weight:bold; cursor:pointer;">–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨</button>
        </div>
    </div>

    <div id="chat-screen" style="display:none;">
        <header>
            <div class="header-row">
                <button id="back-btn" onclick="showStartPlaceholder()" style="display:none; background:none; border:none; color:#fff; font-size:1.5rem; cursor:pointer;">‚Üê</button>
                <div style="flex:1; margin-left:10px;">
                    <b id="chat-title">–ß–∞—Ç—ã</b>
                    <div id="typing-indicator" class="typing-status"></div>
                </div>
                <div id="call-btns" style="display:none; gap:15px; font-size:1.2rem;">
                    <span onclick="startCall(false)" style="cursor:pointer;">üìû</span>
                    <span onclick="startCall(true)" style="cursor:pointer;">üìπ</span>
                </div>
                <button onclick="logout()" style="background:none; border:none; color:#fff; font-size:0.8rem; margin-left:10px; opacity:0.7;">–í—ã—Ö–æ–¥</button>
            </div>
            <input type="text" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="search(this.value)" style="width:100%; margin-top:10px; padding:8px; border-radius:8px; border:none; outline:none;">
            <div id="search-results"></div>
        </header>

        <div id="messages"></div>

        <div class="input-area" id="input-bar" style="display:none;">
            <button onclick="document.getElementById('img-input').click()" style="background:none; border:none; font-size:1.5rem;">üì∑</button>
            <input type="file" id="img-input" hidden onchange="uploadFile(this, 'image')">
            <button id="mic-btn" onclick="toggleMic()" style="background:none; border:none; font-size:1.5rem;">üé§</button>
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." oninput="handleTyping()">
            <button onclick="sendText()" style="width:40px; height:40px; border-radius:50%; border:none; background:var(--main); color:white; cursor:pointer;">‚û§</button>
        </div>
    </div>

    <script>
        // --- –ó–ê–ú–ï–ù–ò–¢–ï –≠–¢–ò –î–ê–ù–ù–´–ï –ù–ê –í–ê–®–ò –ò–ó FIREBASE CONSOLE ---
        const firebaseConfig = {
            apiKey: "–¢–í–û–ô_API_KEY",
            authDomain: "–¢–í–û–ô_PROJECT.firebaseapp.com",
            databaseURL: "https://–¢–í–û–ô_PROJECT.firebaseio.com",
            projectId: "–¢–í–û–ô_PROJECT",
            storageBucket: "–¢–í–û–ô_PROJECT.appspot.com",
            messagingSenderId: "ID",
            appId: "APP_ID"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database(), storage = firebase.storage();
        let currentUser = "", currentAvatar = "", currentChatRoom = null, currentRoomData = null;
        let pc, localStream, mediaRecorder, audioChunks = [], typingTimeout;

        // --- –í–•–û–î –ò –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ---
        window.onload = async () => {
            const n = localStorage.getItem('chat_user'), p = localStorage.getItem('chat_pass');
            if(n && p) {
                const s = await db.ref(`all_users/${n}`).once('value');
                if(s.exists() && s.val().password === p) {
                    currentUser = n; currentAvatar = s.val().avatar || "";
                    enterApp();
                }
            }
        };

        async function login() {
            const n = document.getElementById('username').value.trim().toLowerCase(), p = document.getElementById('password').value.trim(), f = document.getElementById('avatar-input').files[0];
            if(!n || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!");
            
            const s = await db.ref(`all_users/${n}`).once('value');
            if(s.exists()) {
                if(s.val().password !== p) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
                currentUser = n; currentAvatar = s.val().avatar || "";
            } else {
                if(f) { const ref = storage.ref(`avatars/${n}`); await ref.put(f); currentAvatar = await ref.getDownloadURL(); }
                await db.ref(`all_users/${n}`).set({ password: p, avatar: currentAvatar });
                currentUser = n;
            }
            localStorage.setItem('chat_user', currentUser); localStorage.setItem('chat_pass', p);
            enterApp();
        }

        function enterApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            listenForCalls(); showStartPlaceholder(); listenForGlobalNotifs();
        }

        function logout() { localStorage.clear(); location.reload(); }

        function previewAvatar(i) {
            const f = i.files[0];
            if(f) {
                const r = new FileReader();
                r.onload = e => { document.getElementById('avatar-preview').src = e.target.result; document.getElementById('avatar-preview').style.display = 'block'; document.getElementById('avatar-placeholder').style.display = 'none'; };
                r.readAsDataURL(f);
            }
        }

        // --- –ü–û–ò–°–ö –ò –°–ü–ò–°–û–ö –ß–ê–¢–û–í ---
        function search(q) {
            const res = document.getElementById('search-results');
            if(q.length < 2) return res.style.display = 'none';
            res.innerHTML = "";
            db.ref("all_users").orderByKey().startAt(q).endAt(q+"\uf8ff").limitToFirst(5).once("value", s => {
                s.forEach(c => {
                    if(c.key !== currentUser) {
                        const d = document.createElement('div'); d.className='search-item'; d.textContent = "üë§ "+c.key;
                        d.onclick = () => { openPrivate(c.key); res.style.display='none'; };
                        res.appendChild(d);
                    }
                });
            });
            res.style.display = 'block';
        }

        function showStartPlaceholder() {
            currentChatRoom = null;
            document.getElementById('chat-title').textContent = "–ß–∞—Ç—ã";
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('call-btns').style.display = 'none';
            document.getElementById('input-bar').style.display = 'none';
            document.getElementById('typing-indicator').style.display = 'none';
            const msgBox = document.getElementById('messages');
            msgBox.innerHTML = `<div class="recent-chats-list" id="recents"></div>`;
            
            db.ref(`recents/${currentUser}`).orderByChild('at').on('value', s => {
                const rBox = document.getElementById('recents'); if(!rBox) return;
                rBox.innerHTML = ""; let items = []; s.forEach(c => items.unshift(c.val()));
                items.forEach(i => {
                    const d = document.createElement('div'); d.className='chat-item';
                    d.innerHTML = `<div class="user-avatar">${i.avatar ? `<img src="${i.avatar}" style="width:100%;height:100%;border-radius:50%">` : i.name[0].toUpperCase()}</div>
                                   <div><b>${i.name}</b><br><small style="color:gray">${i.last || ''}</small></div>`;
                    d.onclick = () => openPrivate(i.name);
                    rBox.appendChild(d);
                });
            });
        }

        // --- –°–û–û–ë–©–ï–ù–ò–Ø ---
        function openPrivate(target) {
            currentChatRoom = "p2p_" + [currentUser, target].sort().join("_");
            currentRoomData = { name: target, type: 'private' };
            document.getElementById('chat-title').textContent = target;
            document.getElementById('back-btn').style.display = 'block';
            document.getElementById('call-btns').style.display = 'flex';
            document.getElementById('input-bar').style.display = 'flex';
            loadMessages(); listenForTyping();
            db.ref(`all_users/${target}`).once('value', s => {
                db.ref(`recents/${currentUser}/${currentChatRoom}`).update({ name: target, at: Date.now(), avatar: s.val().avatar || "" });
            });
        }

        function sendText() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text || !currentChatRoom) return;
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const target = currentRoomData.name;

            const msgData = { s: currentUser, t: text, at: time, timestamp: Date.now(), read: false };
            db.ref(`messages/${currentChatRoom}`).push().set(msgData);

            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ—Å–µ–Ω—Ç–æ–≤
            const update = { at: Date.now(), last: text };
            db.ref(`recents/${currentUser}/${currentChatRoom}`).update(update);
            db.ref(`recents/${target}/${currentChatRoom}`).update({...update, name: currentUser, avatar: currentAvatar});

            input.value = ""; db.ref(`typing/${currentChatRoom}/${currentUser}`).remove();
        }

        function loadMessages() {
            const container = document.getElementById('messages');
            db.ref(`messages/${currentChatRoom}`).off();
            db.ref(`messages/${currentChatRoom}`).on("value", async s => {
                container.innerHTML = "";
                const uSnap = await db.ref("all_users").once("value"), users = uSnap.val() || {};
                s.forEach(c => {
                    const data = c.val(), msgId = c.key, isMine = data.s === currentUser;
                    if (!isMine && !data.read) db.ref(`messages/${currentChatRoom}/${msgId}/read`).set(true);
                    
                    const statusHtml = isMine ? `<span class="read-status ${data.read?'read':'unread'}">${data.read?'‚úì‚úì':'‚úì'}</span>` : "";
                    const wrap = document.createElement('div'); wrap.className = `msg-wrapper ${isMine?'mine':'others'}`;
                    wrap.innerHTML = `<div class="user-avatar">${users[data.s]?.avatar ? `<img src="${users[data.s].avatar}" style="width:100%;height:100%;border-radius:50%">` : data.s[0].toUpperCase()}</div>
                        <div class="msg">
                            <div style="display:flex; justify-content:space-between; gap:10px;">
                                <b style="font-size:0.7rem; color:var(--main);">${data.s}</b>
                                ${isMine ? `<span onclick="deleteMessage('${msgId}')" style="cursor:pointer; opacity:0.5; font-size:0.7rem;">üóëÔ∏è</span>` : ''}
                            </div>
                            <div>${data.t}</div>
                            <div style="font-size:0.6rem; text-align:right; opacity:0.5; margin-top:3px;">${data.at} ${statusHtml}</div>
                        </div>`;
                    container.appendChild(wrap);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        function deleteMessage(id) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) db.ref(`messages/${currentChatRoom}/${id}`).remove();
        }

        // --- –î–û–ü. –§–£–ù–ö–¶–ò–ò (–°–¢–ê–¢–£–°, –ó–í–£–ö, –¢–ò–ü–ò–ù–ì) ---
        function handleTyping() {
            db.ref(`typing/${currentChatRoom}/${currentUser}`).set(true);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => db.ref(`typing/${currentChatRoom}/${currentUser}`).remove(), 2000);
        }

        function listenForTyping() {
            db.ref(`typing/${currentChatRoom}`).on("value", s => {
                let t = []; s.forEach(c => { if(c.key !== currentUser) t.push(c.key); });
                const ind = document.getElementById('typing-indicator');
                ind.style.display = t.length ? 'block' : 'none';
                ind.textContent = t.join(", ") + " –ø–µ—á–∞—Ç–∞–µ—Ç...";
            });
        }

        function listenForGlobalNotifs() {
            db.ref(`recents/${currentUser}`).on('child_changed', s => {
                if(s.val().last && !currentChatRoom) {
                    document.getElementById('notif-sound').play().catch(()=>{});
                }
            });
        }

        // --- WEBRTC –ó–í–û–ù–ö–ò ---
        const rtcCfg = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };
        async function startCall(v) {
            const target = currentRoomData.name; document.getElementById('call-screen').style.display='flex';
            localStream = await navigator.mediaDevices.getUserMedia({ video: v, audio: true });
            document.getElementById('local-video').srcObject = localStream;
            pc = new RTCPeerConnection(rtcCfg);
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            pc.onicecandidate = e => e.candidate && db.ref(`calls/${target}/ice`).set(JSON.stringify(e.candidate));
            pc.ontrack = e => document.getElementById('remote-video').srcObject = e.streams[0];
            const off = await pc.createOffer(); await pc.setLocalDescription(off);
            db.ref(`calls/${target}/off`).set({ from: currentUser, sdp: JSON.stringify(off), v });
            db.ref(`calls/${currentUser}/ans`).on("value", async s => { if(s.val()) await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(s.val()))); });
        }

        function listenForCalls() {
            db.ref(`calls/${currentUser}/off`).on("value", async s => {
                const d = s.val(); if(d && confirm(`–ó–≤–æ–Ω–æ–∫ –æ—Ç ${d.from}. –û—Ç–≤–µ—Ç–∏—Ç—å?`)) {
                    document.getElementById('call-screen').style.display='flex';
                    localStream = await navigator.mediaDevices.getUserMedia({ video: d.v, audio: true });
                    document.getElementById('local-video').srcObject = localStream;
                    pc = new RTCPeerConnection(rtcCfg);
                    localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
                    pc.ontrack = e => document.getElementById('remote-video').srcObject = e.streams[0];
                    await pc.setRemoteDescription(new RTCSessionDescription(JSON.parse(d.sdp)));
                    const ans = await pc.createAnswer(); await pc.setLocalDescription(ans);
                    db.ref(`calls/${d.from}/ans`).set(JSON.stringify(ans));
                }
            });
        }

        function endCall() { if(pc) pc.close(); if(localStream) localStream.getTracks().forEach(t=>t.stop()); db.ref(`calls/${currentUser}`).remove(); document.getElementById('call-screen').style.display='none'; }

        async function uploadFile(i, type) {
            const f = i.files[0]; if(!f) return;
            const r = storage.ref(`uploads/${Date.now()}`); await r.put(f);
            const url = await r.getDownloadURL();
            db.ref(`messages/${currentChatRoom}`).push().set({ s: currentUser, t: type==='image'?'üì∑ –§–æ—Ç–æ':'üé§ –ì–æ–ª–æ—Å', [type==='image'?'img':'v']: url, at: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}), timestamp: Date.now() });
        }

        async function toggleMic() {
            if(!mediaRecorder || mediaRecorder.state==="inactive") {
                const s = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(s); audioChunks = [];
                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = () => { const b = new Blob(audioChunks, {type:'audio/webm'}); uploadFile({files:[b]}, 'voice'); s.getTracks().forEach(t=>t.stop()); };
                mediaRecorder.start(); document.getElementById('mic-btn').textContent = "üõë";
            } else { mediaRecorder.stop(); document.getElementById('mic-btn').textContent = "üé§"; }
        }

        document.getElementById('msg-input').onkeypress = e => e.key==='Enter' && sendText();
    </script>
</body>
</html>
