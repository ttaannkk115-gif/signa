<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Universe Messenger Fix</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>
    
    <style>
        :root { --main: #075e54; --accent: #25d366; --bg: #e5ddd5; --light: #dcf8c6; --blue: #34b7f1; }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: var(--bg); height: 100vh; overflow: hidden; display: flex; justify-content: center; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .screen { width: 100%; max-width: 500px; background: #fff; height: 100vh; display: flex; flex-direction: column; position: relative; }
        #login-screen { justify-content: center; align-items: center; background: #f0f2f5; }

        /* –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ */
        .login-card { background: #fff; padding: 30px; border-radius: 15px; width: 90%; box-shadow: 0 10px 25px rgba(0,0,0,0.1); text-align: center; }
        input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; outline: none; }
        button { width: 100%; padding: 12px; background: var(--main); color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        button:disabled { background: #ccc; }

        /* –ß–∞—Ç */
        header { background: var(--main); color: #fff; padding: 15px; }
        #messages { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; background: #e5ddd5 url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); }
        
        .msg-wrapper { display: flex; gap: 8px; max-width: 85%; align-items: flex-end; }
        .msg-wrapper.mine { align-self: flex-end; flex-direction: row-reverse; }
        .msg { padding: 8px 12px; border-radius: 12px; font-size: 0.9rem; background: #fff; box-shadow: 0 1px 1px rgba(0,0,0,0.1); }
        .mine .msg { background: var(--light); }
        
        .recent-item { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .avatar { width: 45px; height: 45px; border-radius: 50%; background: #ccc; margin-right: 12px; display: flex; align-items: center; justify-content: center; color: #fff; overflow: hidden; }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }

        .input-bar { padding: 10px; background: #f0f0f0; display: flex; gap: 10px; }
        #search-box { padding: 10px; background: var(--main); }
        #search-results { background: #fff; position: absolute; width: 100%; z-index: 10; max-height: 200px; overflow-y: auto; box-shadow: 0 5px 10px rgba(0,0,0,0.1); }
        .search-item { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen">
        <div class="login-card">
            <h2 style="color: var(--main); margin-bottom: 20px;">Universe Messenger</h2>
            <input type="text" id="username" placeholder="–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="login-btn" onclick="handleAuth()">–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨</button>
            <p id="auth-status" style="font-size: 0.8rem; margin-top: 10px; color: red;"></p>
        </div>
    </div>

    <div id="chat-screen" class="screen" style="display: none;">
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <button id="back-btn" onclick="goBack()" style="width: auto; background: none; display: none;">‚Üê –ù–∞–∑–∞–¥</button>
                <b id="chat-title">–ß–∞—Ç—ã</b>
                <span onclick="logout()" style="cursor: pointer; font-size: 0.8rem;">–í—ã—Ö–æ–¥</span>
            </div>
        </header>

        <div id="search-box">
            <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ –ª—é–¥–µ–π..." oninput="doSearch(this.value)" style="margin-bottom: 0;">
            <div id="search-results"></div>
        </div>

        <div id="messages"></div>

        <div class="input-bar" id="input-bar" style="display: none;">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()" style="width: 60px;">‚û§</button>
        </div>
    </div>

    <script>
        // 1. –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø (–í–°–¢–ê–í–¨ –°–í–û–ò –î–ê–ù–ù–´–ï)
        const firebaseConfig = {
            apiKey: "–¢–í–û–ô_–ö–õ–Æ–ß",
            authDomain: "–¢–í–û–ô_–ü–†–û–ï–ö–¢.firebaseapp.com",
            databaseURL: "https://–¢–í–û–ô_–ü–†–û–ï–ö–¢.firebaseio.com",
            projectId: "–¢–í–û–ô_–ü–†–û–ï–ö–¢",
            storageBucket: "–¢–í–û–ô_–ü–†–û–ï–ö–¢.appspot.com",
            messagingSenderId: "ID",
            appId: "APP_ID"
        };

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        let currentUser = localStorage.getItem('chat_user') || "";
        let currentChatRoom = null;
        let currentTarget = "";

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ-–≤—Ö–æ–¥–∞
        if (currentUser) {
            showChatScreen();
        }

        // --- –õ–û–ì–ò–ö–ê –ê–£–¢–ï–ù–¢–ò–§–ò–ö–ê–¶–ò–ò ---
        async function handleAuth() {
            const n = document.getElementById('username').value.trim().toLowerCase();
            const p = document.getElementById('password').value.trim();
            const status = document.getElementById('auth-status');
            const btn = document.getElementById('login-btn');

            if (!n || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");

            btn.disabled = true;
            status.textContent = "–ü—Ä–æ–≤–µ—Ä–∫–∞...";

            try {
                const userRef = db.ref(`all_users/${n}`);
                const snapshot = await userRef.once('value');

                if (snapshot.exists()) {
                    // –í—Ö–æ–¥
                    if (snapshot.val().password === p) {
                        loginSuccess(n);
                    } else {
                        status.textContent = "–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!";
                        btn.disabled = false;
                    }
                } else {
                    // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                    await userRef.set({ password: p, avatar: "" });
                    loginSuccess(n);
                }
            } catch (e) {
                status.textContent = "–û—à–∏–±–∫–∞: " + e.message;
                console.error(e);
                btn.disabled = false;
            }
        }

        function loginSuccess(name) {
            currentUser = name;
            localStorage.setItem('chat_user', name);
            showChatScreen();
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function showChatScreen() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            loadRecentChats();
        }

        function goBack() {
            currentChatRoom = null;
            document.getElementById('back-btn').style.display = 'none';
            document.getElementById('input-bar').style.display = 'none';
            document.getElementById('chat-title').textContent = "–ß–∞—Ç—ã";
            document.getElementById('messages').innerHTML = "";
            loadRecentChats();
        }

        // --- –ü–û–ò–°–ö ---
        function doSearch(q) {
            const res = document.getElementById('search-results');
            if (q.length < 2) { res.innerHTML = ""; return; }

            db.ref("all_users").orderByKey().startAt(q).endAt(q + "\uf8ff").limitToFirst(5).once("value", s => {
                res.innerHTML = "";
                s.forEach(user => {
                    if (user.key !== currentUser) {
                        const div = document.createElement('div');
                        div.className = 'search-item';
                        div.textContent = "üë§ " + user.key;
                        div.onclick = () => openChat(user.key);
                        res.appendChild(div);
                    }
                });
            });
        }

        // --- –ß–ê–¢ ---
        function openChat(target) {
            currentTarget = target;
            currentChatRoom = "p2p_" + [currentUser, target].sort().join("_");
            document.getElementById('search-results').innerHTML = "";
            document.getElementById('search-input').value = "";
            document.getElementById('chat-title').textContent = target;
            document.getElementById('back-btn').style.display = 'block';
            document.getElementById('input-bar').style.display = 'flex';
            loadMessages();
        }

        function sendMsg() {
            const inp = document.getElementById('msg-input');
            const txt = inp.value.trim();
            if (!txt || !currentChatRoom) return;

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const msgData = { s: currentUser, t: txt, at: time, read: false };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            db.ref(`messages/${currentChatRoom}`).push().set(msgData);

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –¥–ª—è –æ–±–æ–∏—Ö
            const lastData = { name: currentTarget, last: txt, at: Date.now() };
            db.ref(`recents/${currentUser}/${currentChatRoom}`).update(lastData);
            db.ref(`recents/${currentTarget}/${currentChatRoom}`).update({ name: currentUser, last: txt, at: Date.now() });

            inp.value = "";
        }

        function loadMessages() {
            const container = document.getElementById('messages');
            db.ref(`messages/${currentChatRoom}`).off();
            db.ref(`messages/${currentChatRoom}`).on("value", s => {
                container.innerHTML = "";
                s.forEach(m => {
                    const d = m.val();
                    const isMine = d.s === currentUser;
                    
                    // –ü–æ–º–µ—á–∞–µ–º –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–æ
                    if(!isMine && !d.read) db.ref(`messages/${currentChatRoom}/${m.key}/read`).set(true);

                    const wrap = document.createElement('div');
                    wrap.className = `msg-wrapper ${isMine ? 'mine' : 'others'}`;
                    wrap.innerHTML = `<div class="msg">
                        <div style="font-size:0.7rem; color:var(--main); font-weight:bold;">${d.s}</div>
                        ${d.t}
                        <div style="font-size:0.6rem; text-align:right; opacity:0.5;">${d.at} ${isMine ? (d.read?'<span style="color:var(--blue)">‚úì‚úì</span>':'‚úì') : ''}</div>
                    </div>`;
                    container.appendChild(wrap);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        function loadRecentChats() {
            const container = document.getElementById('messages');
            db.ref(`recents/${currentUser}`).orderByChild('at').on('value', s => {
                if (currentChatRoom) return; // –ù–µ –ø–µ—Ä–µ–±–∏–≤–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—ã–π —á–∞—Ç
                container.innerHTML = "";
                let chats = [];
                s.forEach(c => chats.unshift(c.val()));
                
                if (chats.length === 0) {
                    container.innerHTML = "<center style='margin-top:20px; opacity:0.5;'>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —á–∞—Ç–æ–≤.<br>–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–æ–∏—Å–∫.</center>";
                }

                chats.forEach(c => {
                    const div = document.createElement('div');
                    div.className = 'recent-item';
                    div.innerHTML = `<div class="avatar">${c.name[0].toUpperCase()}</div>
                                     <div style="flex:1;"><b>${c.name}</b><br><small style="color:gray">${c.last}</small></div>`;
                    div.onclick = () => openChat(c.name);
                    container.appendChild(div);
                });
            });
        }
    </script>
</body>
</html>
